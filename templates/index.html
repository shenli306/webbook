<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³¢å¥‡é…±æ¨¡å¼</title>
    <link rel="stylesheet" href="/static/css/index.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <script src="/static/js/api.js"></script>
</head>

<body>

    <header>
        <nav>
            <div class="logo">
                <h4>æ³¢æ³¢æ³¢å¥‡é…±</h4>
            </div>
            <ul>
                <li><a href="/">é¦–é¡µ</a></li>
                <li><a href="/book">å°è¯´</a></li>
                <li><a href="#">ç•™è¨€</a></li>
            </ul>
            <form id="content" onsubmit="return checkSearch(event)">
                <input type="text" name="input" class="input" id="search-input">
                <button type="reset" class="search" id="search-btn"></button>
            </form>
        </nav>
        <h1>æ³¢å¥‡é…±</h1>
    </header>

    <div class="container">
        <!-- ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ -->
        <div id="userInfo" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h3>æ¬¢è¿å›æ¥ï¼Œ<span id="userNickname"></span>å–µ~ (â—•á´—â—•âœ¿)</h3>
        </div>



    </div>

    <div class="content-section">
        <!-- å·¦ä¾§ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- æœ€æ–°èµ„è®¯åŒºåŸŸ -->
            <div class="news-banner">
                <div class="news-header">
                    <h2>æœ€æ–°èµ„è®¯</h2>
                </div>
                <div class="news-list">
                    <a href="#" class="news-item">
                        <span class="news-date">2024-03-24</span>
                        <span class="news-title">ç½‘ç«™æ”¹ç‰ˆæ›´æ–°å…¬å‘Š</span>
                    </a>
                    <a href="#" class="news-item">
                        <span class="news-date">2024-03-23</span>
                        <span class="news-title">æ–°å¢MMDæ¨¡å‹ä¸‹è½½</span>
                    </a>
                    <a href="#" class="news-item">
                        <span class="news-date">2024-03-22</span>
                        <span class="news-title">Blenderæ•™ç¨‹æ›´æ–°</span>
                    </a>
                </div>
            </div>

            <!-- åŠ¨æ€èµ„æºå¡ç‰‡åŒºåŸŸ -->
            <div class="cards">
                <div class="card-grid" id="cardGrid">
                    <!-- åŠ¨æ€åŠ è½½èµ„æºå¡ç‰‡ -->
                </div>
                <!-- åˆ†é¡µå¯¼èˆª -->
                <div class="pagination" id="pagination" style="display: none;">
                    <!-- åˆ†é¡µæŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- é™æ€å¡ç‰‡å·²ç§»åŠ¨åˆ°åŠ¨æ€èµ„æºç®¡ç†ä¸­ -->
        </div>

        <!-- å³ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="profile-card">
                <div class="profile-icon" id="profile-avatar">
                    <img src="/static/img/preview.jpg" alt="æ³¢å¥‡é…±">
                    <div class="dropdown-menu" id="dropdown-menu">
                        <a href="/static/login.html" class="dropdown-item">ç™»å½•</a>
                        <a href="/static/register.html" class="dropdown-item">æ³¨å†Œ</a>
                    </div>
                </div>
                <div class="admin-welcome" id="adminWelcome" style="display: none;">
                    <p class="welcome-text">æ¬¢è¿å›æ¥ï¼Œç®¡ç†å‘˜å–µ~ (â—•á´—â—•âœ¿)</p>
                </div>
                <h2 class="profile-name">[&nbsp;&nbsp;&nbsp;]</h2>
                <p class="profile-desc">0v0</p>
                <div class="profile-stats">
                    <div class="stat">
                        <span class="number">6</span>
                        <span class="label">æ–‡ç« </span>
                    </div>
                    <div class="stat">
                        <span class="number">9</span>
                        <span class="label">åˆ†ç±»</span>
                    </div>
                    <div class="stat">
                        <span class="number">1024</span>
                        <span class="label">è®¿é—®é‡</span>
                    </div>
                    <div class="stat">
                        <span class="number">8096å¤©</span>
                        <span class="label">å»ºç«™å¤©æ•°</span>
                    </div>
                </div>
            </div>

            <!-- åˆ†ç±»ç›®å½• -->
            <div class="tag-section">
                <h3>èµ„æºåˆ†ç±»</h3>
                <div class="tags" id="categoryTags">
                    <a href="#" class="tag" onclick="filterByCategory('åŠ¨ç”»')">ğŸ¬ åŠ¨ç”»</a>
                    <a href="#" class="tag" onclick="filterByCategory('æ•™ç¨‹')">ğŸ“š æ•™ç¨‹</a>
                    <a href="#" class="tag" onclick="filterByCategory('ç´ æ')">ğŸ¨ ç´ æ</a>
                    <a href="#" class="tag" onclick="filterByCategory('å·¥å…·')">ğŸ”§ å·¥å…·</a>
                    <a href="#" class="tag" onclick="filterByCategory('å…¶ä»–')">ğŸ“¦ å…¶ä»–</a>
                    <a href="#" class="tag" onclick="filterByCategory('')">ğŸ“‹ å…¨éƒ¨</a>
                </div>
            </div>
        </div>
    </div>

    <script src="js/index.js"></script>
    <script src="js/script.js"></script>
    <script src="js/api.js"></script>
    <script>
        // å…¨å±€å˜é‡å·²åœ¨api.jsä¸­å£°æ˜
        let currentSearchKeyword = '';
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            checkLoginStatus();
            loadResources();
        });
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLoginStatus() {
            const token = localStorage.getItem('token');
            const userInfo = localStorage.getItem('user');
            
            if (token && userInfo) {
                try {
                    const response = await fetch('/api/user/validate', {
                        headers: {
                            'Authorization': 'Bearer ' + token
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        currentUser = JSON.parse(userInfo);
                        showUserInfo();
                    } else {
                        logout();
                    }
                } catch (error) {
                    console.error('éªŒè¯ä»¤ç‰Œå¤±è´¥:', error);
                    logout();
                }
            }
        }
        
        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        function showUserInfo() {
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('userNickname').textContent = currentUser.nickname || currentUser.username;
            document.getElementById('loginLink').style.display = 'none';
            document.getElementById('logoutLink').style.display = 'block';
            document.getElementById('myResourcesLink').style.display = 'block';
        }
        
        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            currentUser = null;
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('loginLink').style.display = 'block';
            document.getElementById('logoutLink').style.display = 'none';
            document.getElementById('myResourcesLink').style.display = 'none';
            loadResources(); // é‡æ–°åŠ è½½å…¬å…±èµ„æº
        }
        

        

        
        // åŠ è½½èµ„æº
        async function loadResources(page = 1, category = '', append = false) {
            try {
                let url = '/api/resources?page=' + page + '&limit=12';
                let headers = {};
                
                // æ·»åŠ åˆ†ç±»ç­›é€‰å‚æ•°
                if (category) {
                    url += '&category=' + encodeURIComponent(category);
                }
                
                if (currentMode === 'my' && currentUser) {
                    url = '/api/resource/my?page=' + page + '&limit=12';
                    if (category) {
                        url += '&category=' + encodeURIComponent(category);
                    }
                    headers['Authorization'] = 'Bearer ' + localStorage.getItem('token');
                }
                
                const response = await fetch(url, { headers });
                const result = await response.json();
                
                if (result.success) {
                    displayResources(result.data, append);
                    currentPage = page;
                    updatePagination(result.total || 0, page);
                } else {
                    console.error('åŠ è½½èµ„æºå¤±è´¥:', result.message);
                }
            } catch (error) {
                console.error('åŠ è½½èµ„æºé”™è¯¯:', error);
            }
        }
        
        // æ˜¾ç¤ºèµ„æº
        function displayResources(resources, append = false) {
            const cardGrid = document.getElementById('cardGrid');
            
            if (resources.length === 0 && !append) {
                cardGrid.innerHTML = '';
                return;
            }
            
            if (!append) {
                cardGrid.innerHTML = '';
            }
            
            resources.forEach(resource => {
                const card = createResourceCard(resource);
                cardGrid.appendChild(card);
            });
        }
        
        // åˆ›å»ºèµ„æºå¡ç‰‡
        function createResourceCard(resource) {
            const card = document.createElement('div');
            card.className = 'card';
            
            card.innerHTML = `
                <a href="${resource.previewUrl || resource.downloadUrl}" target="_blank">
                    <img src="${resource.cover || '/static/img/preview.jpg'}" alt="${resource.title}" onerror="this.src='/static/img/preview.jpg'">
                    <div class="card-content">
                        <h3>${resource.title}</h3>
                        <p>${resource.description}</p>
                        <div style="margin-top: 10px; font-size: 12px; color: #666;">
                            <span>åˆ†ç±»: ${resource.category}</span>
                            <span style="margin-left: 15px;">ä½œè€…: ${resource.authorName}</span>
                        </div>
                        <div style="margin-top: 5px; font-size: 12px; color: #666;">
                            <span>ğŸ‘ï¸ ${resource.viewCount}</span>
                            <span style="margin-left: 15px;">â¬‡ï¸ ${resource.downloadCount}</span>
                        </div>
                    </div>
                </a>
            `;
            
            // ç‚¹å‡»æ—¶å¢åŠ æµè§ˆé‡
            card.addEventListener('click', () => {
                incrementViewCount(resource.id);
            });
            
            return card;
        }
        
        // å¢åŠ æµè§ˆé‡
        async function incrementViewCount(resourceId) {
            try {
                await fetch(`/api/resource/${resourceId}/view`, {
                    method: 'POST'
                });
            } catch (error) {
                console.error('å¢åŠ æµè§ˆé‡å¤±è´¥:', error);
            }
        }
        
        // æ˜¾ç¤ºå…¬å…±èµ„æº
        function showResources() {
            currentMode = 'public';
            currentPage = 1;
            loadResources();
        }
        
        // æ˜¾ç¤ºæˆ‘çš„èµ„æº
        function showMyResources() {
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•å–µ~ (>ï¹<)');
                return;
            }
            currentMode = 'user';
            currentPage = 1;
            loadResources();
        }
        
        // æœç´¢åŠŸèƒ½
        function checkSearch(event) {
            event.preventDefault();
            const searchInput = document.querySelector('#content input[type="text"]');
            const keyword = searchInput.value.trim();
            
            if (keyword) {
                searchResources(keyword);
            }
            
            return false;
        }
        
        // æœç´¢èµ„æº
        async function searchResources(keyword, page = 1) {
            try {
                const response = await fetch(`/api/resources?search=${encodeURIComponent(keyword)}&page=${page}&limit=12`);
                const result = await response.json();
                
                if (result.success) {
                    currentMode = 'search';
                    currentPage = page;
                    currentSearchKeyword = keyword;
                    // æœç´¢ç»“æœæ˜¾ç¤º
                    displayResources(result.data);
                    updatePagination(result.total || 0, page);
                } else {
                    console.error('æœç´¢å¤±è´¥:', result.message);
                }
            } catch (error) {
                console.error('æœç´¢é”™è¯¯:', error);
            }
        }
        
        // æ›´æ–°åˆ†é¡µå¯¼èˆª
        function updatePagination(total, currentPage) {
            const totalPages = Math.ceil(total / 12);
            const paginationContainer = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }
            
            paginationContainer.style.display = 'flex';
            paginationContainer.innerHTML = '';
            
            // ä¸Šä¸€é¡µæŒ‰é’®
            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'ä¸Šä¸€é¡µ';
            prevBtn.className = 'pagination-btn';
            prevBtn.disabled = currentPage <= 1;
            prevBtn.onclick = () => goToPage(currentPage - 1);
            paginationContainer.appendChild(prevBtn);
            
            // é¡µç æŒ‰é’®
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
                const firstBtn = document.createElement('button');
                firstBtn.textContent = '1';
                firstBtn.className = 'pagination-btn';
                firstBtn.onclick = () => goToPage(1);
                paginationContainer.appendChild(firstBtn);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'pagination-ellipsis';
                    paginationContainer.appendChild(ellipsis);
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.className = 'pagination-btn' + (i === currentPage ? ' active' : '');
                pageBtn.onclick = () => goToPage(i);
                paginationContainer.appendChild(pageBtn);
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'pagination-ellipsis';
                    paginationContainer.appendChild(ellipsis);
                }
                
                const lastBtn = document.createElement('button');
                lastBtn.textContent = totalPages;
                lastBtn.className = 'pagination-btn';
                lastBtn.onclick = () => goToPage(totalPages);
                paginationContainer.appendChild(lastBtn);
            }
            
            // ä¸‹ä¸€é¡µæŒ‰é’®
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'ä¸‹ä¸€é¡µ';
            nextBtn.className = 'pagination-btn';
            nextBtn.disabled = currentPage >= totalPages;
            nextBtn.onclick = () => goToPage(currentPage + 1);
            paginationContainer.appendChild(nextBtn);
        }
        
        // è·³è½¬åˆ°æŒ‡å®šé¡µé¢
        function goToPage(page) {
            if (currentMode === 'search' && currentSearchKeyword) {
                searchResources(currentSearchKeyword, page);
            } else {
                loadResources(page);
            }
        }
    </script>
</body>

</html>